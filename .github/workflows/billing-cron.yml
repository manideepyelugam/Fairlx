name: Billing & Usage Cron Jobs

on:
  schedule:
    # Process billing cycle - 1st of each month at midnight UTC
    - cron: '0 0 1 * *'
    # Enforce grace periods - daily at 1 AM UTC
    - cron: '0 1 * * *'
    # Send reminders - daily at 9 AM UTC
    - cron: '0 9 * * *'
    # Aggregate daily usage - daily at 2 AM UTC
    - cron: '0 2 * * *'
    # Evaluate usage alerts - hourly at the 30th minute
    - cron: '30 * * * *'
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to run'
        required: true
        default: 'enforce-grace'
        type: choice
        options:
          - process-cycle
          - enforce-grace
          - send-reminders
          - evaluate-alerts
          - aggregate-daily

# Note: All billing operations use USD as the primary currency.
# Razorpay payments are processed in INR with live conversion rates.

env:
  API_BASE_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
  CRON_SECRET: ${{ secrets.CRON_SECRET }}

jobs:
  billing-cron:
    runs-on: ubuntu-latest
    steps:
      - name: Determine job to run
        id: job
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "job=${{ github.event.inputs.job }}" >> $GITHUB_OUTPUT
          else
            # Determine based on schedule
            HOUR=$(date -u +%H)
            DAY=$(date -u +%d)
            
            if [ "$DAY" == "01" ] && [ "$HOUR" == "00" ]; then
              echo "job=process-cycle" >> $GITHUB_OUTPUT
            elif [ "$HOUR" == "01" ]; then
              echo "job=enforce-grace" >> $GITHUB_OUTPUT
            elif [ "$HOUR" == "02" ]; then
              echo "job=aggregate-daily" >> $GITHUB_OUTPUT
            elif [ "$HOUR" == "09" ]; then
              echo "job=send-reminders" >> $GITHUB_OUTPUT
            elif [ "$(date -u +%M)" == "30" ]; then
              echo "job=evaluate-alerts" >> $GITHUB_OUTPUT
            else
              echo "job=none" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run billing cycle processing
        if: steps.job.outputs.job == 'process-cycle'
        run: |
          echo "üìÖ Running monthly billing cycle processing..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            "$API_BASE_URL/api/cron/billing/process-cycle")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "‚ùå Failed with status $http_code"
            exit 1
          fi
          echo "‚úÖ Billing cycle processed successfully"

      - name: Run grace period enforcement
        if: steps.job.outputs.job == 'enforce-grace'
        run: |
          echo "‚è∞ Running daily grace period enforcement..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            "$API_BASE_URL/api/cron/billing/enforce-grace")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "‚ùå Failed with status $http_code"
            exit 1
          fi
          echo "‚úÖ Grace periods enforced successfully"

      - name: Send reminder emails
        if: steps.job.outputs.job == 'send-reminders'
        run: |
          echo "üìß Sending grace period reminder emails..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            "$API_BASE_URL/api/cron/billing/send-reminders")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "‚ùå Failed with status $http_code"
            exit 1
          fi
          echo "‚úÖ Reminders sent successfully"

      - name: Evaluate usage alerts
        if: steps.job.outputs.job == 'evaluate-alerts'
        run: |
          echo "üîî Evaluating usage alerts..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            "$API_BASE_URL/api/cron/billing/evaluate-alerts")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "‚ùå Failed with status $http_code"
            exit 1
          fi
          echo "‚úÖ Usage alerts evaluated successfully"

      - name: Aggregate daily usage
        if: steps.job.outputs.job == 'aggregate-daily'
        run: |
          echo "üìä Aggregating yesterday's usage events into daily summary..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            "$API_BASE_URL/api/cron/usage/aggregate-daily")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "‚ùå Failed with status $http_code"
            exit 1
          fi
          echo "‚úÖ Daily usage aggregated successfully"

      - name: Skip (no matching job)
        if: steps.job.outputs.job == 'none'
        run: echo "‚è≠Ô∏è No job matched current schedule, skipping..."
