name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        env:
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_APPWRITE_ENDPOINT: ${{ secrets.NEXT_PUBLIC_APPWRITE_ENDPOINT }}
          NEXT_PUBLIC_APPWRITE_PROJECT: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT }}
          NEXT_APPWRITE_KEY: ${{ secrets.NEXT_APPWRITE_KEY }}
          NEXT_PUBLIC_APPWRITE_DATABASE_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_DATABASE_ID }}
          # Organizations & Account Management
          NEXT_PUBLIC_APPWRITE_ORGANIZATIONS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_ORGANIZATIONS_ID }}
          NEXT_PUBLIC_APPWRITE_ORGANIZATION_MEMBERS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_ORGANIZATION_MEMBERS_ID }}
          NEXT_PUBLIC_APPWRITE_LOGIN_TOKENS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_LOGIN_TOKENS_ID }}
          # Workspaces & Members
          NEXT_PUBLIC_APPWRITE_WORKSPACES_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_WORKSPACES_ID }}
          NEXT_PUBLIC_APPWRITE_MEMBERS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_MEMBERS_ID }}
          NEXT_PUBLIC_APPWRITE_PROJECT_MEMBERS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_MEMBERS_ID }}
          NEXT_PUBLIC_APPWRITE_PROJECTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECTS_ID }}
          NEXT_PUBLIC_APPWRITE_PROJECT_ROLES_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_ROLES_ID }}
          NEXT_PUBLIC_APPWRITE_TASKS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_TASKS_ID }}
          NEXT_PUBLIC_APPWRITE_TIME_LOGS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_TIME_LOGS_ID }}
          NEXT_PUBLIC_APPWRITE_SPRINTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_SPRINTS_ID }}
          NEXT_PUBLIC_APPWRITE_WORK_ITEMS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_WORK_ITEMS_ID }}
          NEXT_PUBLIC_APPWRITE_PERSONAL_BACKLOG_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PERSONAL_BACKLOG_ID }}
          NEXT_PUBLIC_APPWRITE_CUSTOM_COLUMNS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_CUSTOM_COLUMNS_ID }}
          NEXT_PUBLIC_APPWRITE_DEFAULT_COLUMN_SETTINGS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_DEFAULT_COLUMN_SETTINGS_ID }}
          NEXT_PUBLIC_APPWRITE_NOTIFICATIONS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_NOTIFICATIONS_ID }}
          NEXT_PUBLIC_APPWRITE_IMAGES_BUCKET_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_IMAGES_BUCKET_ID }}
          NEXT_PUBLIC_APPWRITE_ATTACHMENTS_BUCKET_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_ATTACHMENTS_BUCKET_ID }}
          NEXT_PUBLIC_APPWRITE_ATTACHMENTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_ATTACHMENTS_ID }}
          NEXT_PUBLIC_APPWRITE_COMMENTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_COMMENTS_ID }}
          NEXT_PUBLIC_APPWRITE_PROJECT_DOCS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_DOCS_ID }}
          NEXT_PUBLIC_APPWRITE_PROJECT_DOCS_BUCKET_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_DOCS_BUCKET_ID }}
          NEXT_PUBLIC_APPWRITE_ORGANIZATION_AUDIT_LOGS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_ORGANIZATION_AUDIT_LOGS_ID }}
          NEXT_PUBLIC_APPWRITE_DEPARTMENTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_DEPARTMENTS_ID }}
          NEXT_PUBLIC_APPWRITE_ORG_MEMBER_DEPARTMENTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_ORG_MEMBER_DEPARTMENTS_ID }}
          NEXT_PUBLIC_APPWRITE_ORG_MEMBER_PERMISSIONS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_ORG_MEMBER_PERMISSIONS_ID }}
          NEXT_PUBLIC_APPWRITE_DEPARTMENT_PERMISSIONS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_DEPARTMENT_PERMISSIONS_ID }}
          # Usage Billing
          NEXT_PUBLIC_APPWRITE_USAGE_EVENTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_USAGE_EVENTS_ID }}
          NEXT_PUBLIC_APPWRITE_USAGE_AGGREGATIONS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_USAGE_AGGREGATIONS_ID }}
          NEXT_PUBLIC_APPWRITE_USAGE_ALERTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_USAGE_ALERTS_ID }}
          BILLING_GRACE_PERIOD_DAYS: ${{ secrets.BILLING_GRACE_PERIOD_DAYS }}
          BILLING_CURRENCY: ${{ secrets.BILLING_CURRENCY }}
          USAGE_RATE_TRAFFIC_GB: ${{ secrets.USAGE_RATE_TRAFFIC_GB }}
          USAGE_RATE_STORAGE_GB_MONTH: ${{ secrets.USAGE_RATE_STORAGE_GB_MONTH }}
          USAGE_RATE_COMPUTE_UNIT: ${{ secrets.USAGE_RATE_COMPUTE_UNIT }}
          # Billing & Invoicing
          NEXT_PUBLIC_APPWRITE_BILLING_ACCOUNTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_BILLING_ACCOUNTS_ID }}
          NEXT_PUBLIC_APPWRITE_BILLING_AUDIT_LOGS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_BILLING_AUDIT_LOGS_ID }}
          NEXT_PUBLIC_APPWRITE_STORAGE_SNAPSHOTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_STORAGE_SNAPSHOTS_ID }}
          NEXT_PUBLIC_APPWRITE_INVOICES_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_INVOICES_ID }}
          NEXT_PUBLIC_APPWRITE_PROCESSED_EVENTS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROCESSED_EVENTS_ID }}
          NEXT_PUBLIC_APPWRITE_BILLING_SETTINGS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_BILLING_SETTINGS_ID }}
          # Payment Processing & Currency
          # Primary currency: USD (for display & wallet storage)
          # Razorpay charges: INR (converted at checkout using live rates)
          # EXCHANGE_RATE_API_KEY enables live USDâ†’INR conversion
          RAZORPAY_KEY_ID: ${{ secrets.RAZORPAY_KEY_ID }}
          RAZORPAY_KEY_SECRET: ${{ secrets.RAZORPAY_KEY_SECRET }}
          RAZORPAY_WEBHOOK_SECRET: ${{ secrets.RAZORPAY_WEBHOOK_SECRET }}
          RAZORPAY_BASE_PLAN_ID: ${{ secrets.RAZORPAY_BASE_PLAN_ID }}
          EXCHANGE_RATE_API_KEY: ${{ secrets.EXCHANGE_RATE_API_KEY }}
          ENABLE_EMANDATE: ${{ secrets.ENABLE_EMANDATE }}
          # Wallet
          NEXT_PUBLIC_APPWRITE_WALLETS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_WALLETS_ID }}
          NEXT_PUBLIC_APPWRITE_WALLET_TRANSACTIONS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_WALLET_TRANSACTIONS_ID }}
          NEXT_PUBLIC_APPWRITE_USAGE_DEDUCTIONS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_USAGE_DEDUCTIONS_ID }}
          WALLET_SIG_SECRET: ${{ secrets.WALLET_SIG_SECRET }}
          WALLET_DAILY_TOPUP_LIMIT: ${{ secrets.WALLET_DAILY_TOPUP_LIMIT }}
          # Cron & Auth
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          NEXT_PUBLIC_APPWRITE_VERIFICATION_TOKENS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_VERIFICATION_TOKENS_ID }}
          # Email
          EMAIL_API_KEY: ${{ secrets.EMAIL_API_KEY }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          NEXT_PUBLIC_APPWRITE_SMTP_PROVIDER_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_SMTP_PROVIDER_ID }}
          NEXT_PUBLIC_APPWRITE_EMAIL_TOPIC_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_EMAIL_TOPIC_ID }}
          # GitHub Integration
          NEXT_PUBLIC_APPWRITE_GITHUB_REPOS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_GITHUB_REPOS_ID }}
          NEXT_PUBLIC_APPWRITE_CODE_DOCS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_CODE_DOCS_ID }}
          GH_PERSONAL_TOKEN: ${{ secrets.GH_PERSONAL_TOKEN }}
          # Gemini AI
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Teams & Programs
          NEXT_PUBLIC_APPWRITE_PROJECT_TEAMS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_TEAMS_ID }}
          NEXT_PUBLIC_APPWRITE_PROJECT_TEAM_MEMBERS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_TEAM_MEMBERS_ID }}
          NEXT_PUBLIC_APPWRITE_PROJECT_PERMISSIONS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_PERMISSIONS_ID }}
          NEXT_PUBLIC_APPWRITE_PROGRAMS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROGRAMS_ID }}
          NEXT_PUBLIC_APPWRITE_PROGRAM_MEMBERS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROGRAM_MEMBERS_ID }}
          NEXT_PUBLIC_APPWRITE_PROGRAM_MILESTONES_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROGRAM_MILESTONES_ID }}
          NEXT_PUBLIC_APPWRITE_CUSTOM_ROLES_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_CUSTOM_ROLES_ID }}
          # Spaces & Workflows
          NEXT_PUBLIC_APPWRITE_SPACES_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_SPACES_ID }}
          NEXT_PUBLIC_APPWRITE_SPACE_MEMBERS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_SPACE_MEMBERS_ID }}
          NEXT_PUBLIC_APPWRITE_WORKFLOWS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_WORKFLOWS_ID }}
          NEXT_PUBLIC_APPWRITE_WORKFLOW_STATUSES_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_WORKFLOW_STATUSES_ID }}
          NEXT_PUBLIC_APPWRITE_WORKFLOW_TRANSITIONS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_WORKFLOW_TRANSITIONS_ID }}
          # Custom Fields & Work Items
          NEXT_PUBLIC_APPWRITE_CUSTOM_FIELDS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_CUSTOM_FIELDS_ID }}
          NEXT_PUBLIC_APPWRITE_CUSTOM_WORK_ITEM_TYPES_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_CUSTOM_WORK_ITEM_TYPES_ID }}
          NEXT_PUBLIC_APPWRITE_WORK_ITEM_LINKS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_WORK_ITEM_LINKS_ID }}
          NEXT_PUBLIC_APPWRITE_SAVED_VIEWS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_SAVED_VIEWS_ID }}
          NEXT_PUBLIC_APPWRITE_SUBTASKS_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_SUBTASKS_ID }}
        run: npm run build

      - name: Transfer files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: deployer
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          port: 22
          source: "."
          target: "/var/www/fairlx"
          overwrite: true

      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: deployer
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Navigate to app directory
            cd /var/www/fairlx
            
            # Create .env.local file with production environment variables
            cat > .env.local << EOF
            NODE_ENV=production
            NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
            NEXT_PUBLIC_APPWRITE_ENDPOINT=${{ secrets.NEXT_PUBLIC_APPWRITE_ENDPOINT }}
            NEXT_PUBLIC_APPWRITE_PROJECT=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT }}
            NEXT_APPWRITE_KEY=${{ secrets.NEXT_APPWRITE_KEY }}
            NEXT_PUBLIC_APPWRITE_DATABASE_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_DATABASE_ID }}
            NEXT_PUBLIC_APPWRITE_ORGANIZATIONS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_ORGANIZATIONS_ID }}
            NEXT_PUBLIC_APPWRITE_ORGANIZATION_MEMBERS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_ORGANIZATION_MEMBERS_ID }}
            NEXT_PUBLIC_APPWRITE_LOGIN_TOKENS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_LOGIN_TOKENS_ID }}
            NEXT_PUBLIC_APPWRITE_WORKSPACES_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_WORKSPACES_ID }}
            NEXT_PUBLIC_APPWRITE_MEMBERS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_MEMBERS_ID }}
            NEXT_PUBLIC_APPWRITE_PROJECT_MEMBERS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_MEMBERS_ID }}
            NEXT_PUBLIC_APPWRITE_PROJECTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECTS_ID }}
            NEXT_PUBLIC_APPWRITE_PROJECT_ROLES_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_ROLES_ID }}
            NEXT_PUBLIC_APPWRITE_TASKS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_TASKS_ID }}
            NEXT_PUBLIC_APPWRITE_TIME_LOGS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_TIME_LOGS_ID }}
            NEXT_PUBLIC_APPWRITE_SPRINTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_SPRINTS_ID }}
            NEXT_PUBLIC_APPWRITE_WORK_ITEMS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_WORK_ITEMS_ID }}
            NEXT_PUBLIC_APPWRITE_PERSONAL_BACKLOG_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PERSONAL_BACKLOG_ID }}
            NEXT_PUBLIC_APPWRITE_CUSTOM_COLUMNS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_CUSTOM_COLUMNS_ID }}
            NEXT_PUBLIC_APPWRITE_DEFAULT_COLUMN_SETTINGS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_DEFAULT_COLUMN_SETTINGS_ID }}
            NEXT_PUBLIC_APPWRITE_NOTIFICATIONS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_NOTIFICATIONS_ID }}
            NEXT_PUBLIC_APPWRITE_IMAGES_BUCKET_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_IMAGES_BUCKET_ID }}
            NEXT_PUBLIC_APPWRITE_ATTACHMENTS_BUCKET_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_ATTACHMENTS_BUCKET_ID }}
            NEXT_PUBLIC_APPWRITE_ATTACHMENTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_ATTACHMENTS_ID }}
            NEXT_PUBLIC_APPWRITE_COMMENTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_COMMENTS_ID }}
            NEXT_PUBLIC_APPWRITE_PROJECT_DOCS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_DOCS_ID }}
            NEXT_PUBLIC_APPWRITE_PROJECT_DOCS_BUCKET_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_DOCS_BUCKET_ID }}
            NEXT_PUBLIC_APPWRITE_ORGANIZATION_AUDIT_LOGS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_ORGANIZATION_AUDIT_LOGS_ID }}
            NEXT_PUBLIC_APPWRITE_DEPARTMENTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_DEPARTMENTS_ID }}
            NEXT_PUBLIC_APPWRITE_ORG_MEMBER_DEPARTMENTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_ORG_MEMBER_DEPARTMENTS_ID }}
            NEXT_PUBLIC_APPWRITE_ORG_MEMBER_PERMISSIONS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_ORG_MEMBER_PERMISSIONS_ID }}
            NEXT_PUBLIC_APPWRITE_DEPARTMENT_PERMISSIONS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_DEPARTMENT_PERMISSIONS_ID }}
            NEXT_PUBLIC_APPWRITE_USAGE_EVENTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_USAGE_EVENTS_ID }}
            NEXT_PUBLIC_APPWRITE_USAGE_AGGREGATIONS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_USAGE_AGGREGATIONS_ID }}
            NEXT_PUBLIC_APPWRITE_USAGE_ALERTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_USAGE_ALERTS_ID }}
            BILLING_GRACE_PERIOD_DAYS=${{ secrets.BILLING_GRACE_PERIOD_DAYS }}
            BILLING_CURRENCY=${{ secrets.BILLING_CURRENCY }}
            USAGE_RATE_TRAFFIC_GB=${{ secrets.USAGE_RATE_TRAFFIC_GB }}
            USAGE_RATE_STORAGE_GB_MONTH=${{ secrets.USAGE_RATE_STORAGE_GB_MONTH }}
            USAGE_RATE_COMPUTE_UNIT=${{ secrets.USAGE_RATE_COMPUTE_UNIT }}
            NEXT_PUBLIC_APPWRITE_BILLING_ACCOUNTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_BILLING_ACCOUNTS_ID }}
            NEXT_PUBLIC_APPWRITE_BILLING_AUDIT_LOGS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_BILLING_AUDIT_LOGS_ID }}
            NEXT_PUBLIC_APPWRITE_STORAGE_SNAPSHOTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_STORAGE_SNAPSHOTS_ID }}
            NEXT_PUBLIC_APPWRITE_INVOICES_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_INVOICES_ID }}
            NEXT_PUBLIC_APPWRITE_PROCESSED_EVENTS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROCESSED_EVENTS_ID }}
            NEXT_PUBLIC_APPWRITE_BILLING_SETTINGS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_BILLING_SETTINGS_ID }}
            # Payment Processing & Currency (USD primary, INR for Razorpay with live conversion)
            RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
            RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
            RAZORPAY_WEBHOOK_SECRET=${{ secrets.RAZORPAY_WEBHOOK_SECRET }}
            RAZORPAY_BASE_PLAN_ID=${{ secrets.RAZORPAY_BASE_PLAN_ID }}
            EXCHANGE_RATE_API_KEY=${{ secrets.EXCHANGE_RATE_API_KEY }}
            ENABLE_EMANDATE=${{ secrets.ENABLE_EMANDATE }}
            NEXT_PUBLIC_APPWRITE_WALLETS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_WALLETS_ID }}
            NEXT_PUBLIC_APPWRITE_WALLET_TRANSACTIONS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_WALLET_TRANSACTIONS_ID }}
            NEXT_PUBLIC_APPWRITE_USAGE_DEDUCTIONS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_USAGE_DEDUCTIONS_ID }}
            WALLET_SIG_SECRET=${{ secrets.WALLET_SIG_SECRET }}
            WALLET_DAILY_TOPUP_LIMIT=${{ secrets.WALLET_DAILY_TOPUP_LIMIT }}
            CRON_SECRET=${{ secrets.CRON_SECRET }}
            NEXT_PUBLIC_APPWRITE_VERIFICATION_TOKENS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_VERIFICATION_TOKENS_ID }}
            EMAIL_API_KEY=${{ secrets.EMAIL_API_KEY }}
            EMAIL_FROM=${{ secrets.EMAIL_FROM }}
            NEXT_PUBLIC_APPWRITE_SMTP_PROVIDER_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_SMTP_PROVIDER_ID }}
            NEXT_PUBLIC_APPWRITE_EMAIL_TOPIC_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_EMAIL_TOPIC_ID }}
            NEXT_PUBLIC_APPWRITE_GITHUB_REPOS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_GITHUB_REPOS_ID }}
            NEXT_PUBLIC_APPWRITE_CODE_DOCS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_CODE_DOCS_ID }}
            GH_PERSONAL_TOKEN=${{ secrets.GH_PERSONAL_TOKEN }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            NEXT_PUBLIC_APPWRITE_PROJECT_TEAMS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_TEAMS_ID }}
            NEXT_PUBLIC_APPWRITE_PROJECT_TEAM_MEMBERS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_TEAM_MEMBERS_ID }}
            NEXT_PUBLIC_APPWRITE_PROJECT_PERMISSIONS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_PERMISSIONS_ID }}
            NEXT_PUBLIC_APPWRITE_PROGRAMS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROGRAMS_ID }}
            NEXT_PUBLIC_APPWRITE_PROGRAM_MEMBERS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROGRAM_MEMBERS_ID }}
            NEXT_PUBLIC_APPWRITE_PROGRAM_MILESTONES_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROGRAM_MILESTONES_ID }}
            NEXT_PUBLIC_APPWRITE_CUSTOM_ROLES_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_CUSTOM_ROLES_ID }}
            NEXT_PUBLIC_APPWRITE_PROJECT_ROLES_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_ROLES_ID }}
            NEXT_PUBLIC_APPWRITE_PROJECT_MEMBERS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_MEMBERS_ID }}
            NEXT_PUBLIC_APPWRITE_SPACES_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_SPACES_ID }}
            NEXT_PUBLIC_APPWRITE_SPACE_MEMBERS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_SPACE_MEMBERS_ID }}
            NEXT_PUBLIC_APPWRITE_WORKFLOWS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_WORKFLOWS_ID }}
            NEXT_PUBLIC_APPWRITE_WORKFLOW_STATUSES_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_WORKFLOW_STATUSES_ID }}
            NEXT_PUBLIC_APPWRITE_WORKFLOW_TRANSITIONS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_WORKFLOW_TRANSITIONS_ID }}
            NEXT_PUBLIC_APPWRITE_CUSTOM_FIELDS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_CUSTOM_FIELDS_ID }}
            NEXT_PUBLIC_APPWRITE_CUSTOM_WORK_ITEM_TYPES_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_CUSTOM_WORK_ITEM_TYPES_ID }}
            NEXT_PUBLIC_APPWRITE_WORK_ITEM_LINKS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_WORK_ITEM_LINKS_ID }}
            NEXT_PUBLIC_APPWRITE_SAVED_VIEWS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_SAVED_VIEWS_ID }}
            NEXT_PUBLIC_APPWRITE_SUBTASKS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_SUBTASKS_ID }}
            NEXT_PUBLIC_APPWRITE_LOGIN_TOKENS_ID=${{ secrets.NEXT_PUBLIC_APPWRITE_LOGIN_TOKENS_ID }}
            EOF
            
            # Ensure proper permissions
            chmod 600 .env.local
            
            # Install dependencies (keep tsx for running server.ts)
            npm ci
            
            # Create PM2 ecosystem config for Socket.IO server
            # Using tsx for production since it handles TypeScript and path aliases correctly
            cat > ecosystem.config.js << 'EOFPM2'
            module.exports = {
              apps: [{
                name: 'fairlx',
                script: 'npm',
                args: 'start',
                cwd: '/var/www/fairlx',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                },
                instances: 1,
                exec_mode: 'fork',
                max_memory_restart: '1G',
                watch: false,
                autorestart: true,
                restart_delay: 4000,
                max_restarts: 10
              }]
            };
            EOFPM2
            
            # Restart PM2 process
            pm2 restart fairlx || pm2 start ecosystem.config.js --name fairlx
            
            # Wait for the application to start
            sleep 10
            
            # Check if the application is running
            pm2 list
            
            # Save PM2 configuration
            pm2 save
            
            echo "Deployment completed successfully!"
